<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gestor de Cron√≥metros</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #dbdace;
    color: #212121;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
  }

  h1 { margin-bottom: 10px; }

  .controls { margin-bottom: 20px; }

  button {
    background: #113b8f;
    border: none;
    color: #212121;
    padding: 8px 14px;
    margin: 4px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
  }
  button:hover { background: #444; }

  #timers-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    width: 90%;
    max-width: 900px;
  }

  .timer {
    background: #1c1c1c;
    border: 1px solid #333;
    border-radius: 10px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .timer.completed {
    background: #164d16;
    border-color: #1d7a1d;
  }

  .timer h3 { margin: 5px 0; }
  .timer p { margin: 2px 0; }

  .timer .buttons {
    display: flex;
    gap: 6px;
  }

  .draggable { cursor: move; }

  .input-group {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 8px;
  }

  input, textarea {
    padding: 6px;
    border-radius: 5px;
    border: 1px solid #555;
    background: #181818;
    color: #eee;
  }

  textarea { resize: vertical; }

  .hidden { display: none; }

  #userSection { margin-bottom: 20px; text-align: center; }

  /* Panel de login */
  #loginPanel {
    background: #1c1c1c;
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #333;
    text-align: center;
  }

  #loginPanel input {
    width: 200px;
    margin: 5px 0;
  }
</style>
</head>
<body>

<h1>Gestor de Cron√≥metros</h1>

<!-- üîê LOGIN -->
<div id="loginPanel">
  <h3>Acceso privado</h3>
  <input type="email" id="emailInput" placeholder="Correo autorizado">
  <input type="password" id="passwordInput" placeholder="Contrase√±a">
  <button id="loginEmailBtn">Ingresar</button>
  <p id="loginError" style="color:#ff5555;"></p>
</div>

<!-- üîê Info de usuario -->
<div id="userSection" class="hidden">
  <p id="userInfo"></p>
  <button id="logoutBtn">Cerrar sesi√≥n</button>
</div>

<div class="controls hidden" id="mainControls">
  <button id="startDayBtn">üåÖ Iniciar D√≠a</button>
  <button id="endDayBtn">üåá Finalizar D√≠a</button>
  <button id="addTimerBtn">‚ûï Nuevo Cron√≥metro</button>
</div>

<div id="formSection" class="hidden">
  <div class="input-group">
    <input type="text" id="activityName" placeholder="Nombre de la actividad">
    <input type="number" id="targetMinutes" placeholder="Minutos objetivo" min="1">
  </div>
  <div class="input-group">
    <textarea id="note" placeholder="Nota (opcional)"></textarea>
  </div>
  <button id="createTimerBtn">Crear</button>
</div>

<div id="timers-container"></div>

<!-- üî• Firebase + l√≥gica -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
  import { 
    getAuth, 
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCby9oxzPzBDllkzuW21ZoGNJh67UgYZ8E",
    authDomain: "notion-timers-2a3bb.firebaseapp.com",
    databaseURL: "https://notion-timers-2a3bb-default-rtdb.firebaseio.com",
    projectId: "notion-timers-2a3bb",
    storageBucket: "notion-timers-2a3bb.firebasestorage.app",
    messagingSenderId: "78500747038",
    appId: "1:78500747038:web:2b5fdec3731a203c7f1b0f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  let dbRef;
  let timers = [];
  let dayStarted = null;
  let dayEnded = null;

  // üìå Login email/password
  document.getElementById("loginEmailBtn").onclick = async () => {
    const email = document.getElementById("emailInput").value;
    const pass = document.getElementById("passwordInput").value;

    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (e) {
      document.getElementById("loginError").textContent = "Credenciales incorrectas";
    }
  };

  document.getElementById("logoutBtn").onclick = () => signOut(auth);

  onAuthStateChanged(auth, user => {
    if (user) {
      document.getElementById("loginPanel").classList.add("hidden");
      document.getElementById("userSection").classList.remove("hidden");
      document.getElementById("mainControls").classList.remove("hidden");
      document.getElementById("userInfo").textContent = `Conectado como: ${user.email}`;
      dbRef = ref(db, `usuarios/${user.uid}/cronometros/diaActual`);
      listen();
    } else {
      document.getElementById("loginPanel").classList.remove("hidden");
      document.getElementById("userSection").classList.add("hidden");
      document.getElementById("mainControls").classList.add("hidden");
      timers = [];
      renderTimers();
    }
  });

  function listen() {
    onValue(dbRef, snap => {
      const data = snap.val() || {};
      timers = data.timers || [];
      dayStarted = data.dayStarted || null;
      dayEnded = data.dayEnded || null;
      renderTimers();
    });
  }

  function save() {
    if (!dbRef) return;
    set(dbRef, { timers, dayStarted, dayEnded, updatedAt: new Date().toISOString() });
  }

  function formatTime(s) {
    const h = String(Math.floor(s / 3600)).padStart(2,"0");
    const m = String(Math.floor((s%3600)/60)).padStart(2,"0");
    const s2 = String(s%60).padStart(2,"0");
    return `${h}:${m}:${s2}`;
  }

  function renderTimers() {
    const container = document.getElementById("timers-container");
    container.innerHTML = "";
    timers.forEach((t,i)=>{
      const div = document.createElement("div");
      div.className = "timer draggable" + (t.completed ? " completed" : "");
      div.draggable = true;
      div.innerHTML = `
        <h3>${t.name}</h3>
        <p>Objetivo: ${t.target} min</p>
        <p>Tiempo: <span>${formatTime(t.elapsed)}</span></p>
        ${t.note ? `<p><i>${t.note}</i></p>` : ""}
        <div class="buttons">
          <button onclick="toggleTimer(${i})">${t.running?"‚è∏Ô∏è Pausa":"‚ñ∂Ô∏è Iniciar"}</button>
          <button onclick="resetTimer(${i})">üîÑ Reset</button>
          <button onclick="deleteTimer(${i})">üóëÔ∏è Borrar</button>
        </div>
      `;
      container.appendChild(div);
    });
    enableDragAndDrop(); // habilitar drag cada vez que renderizamos
  }

  // üîÑ Funciones de control
  window.toggleTimer = i => {
    if (!dayStarted) return alert("Primero inicia el d√≠a.");
    timers[i].running = !timers[i].running;
    renderTimers();
  };

  window.resetTimer = i => {
    timers[i].elapsed = 0;
    timers[i].running = false;
    timers[i].completed = false;
    renderTimers();
  };

  window.deleteTimer = i => {
    timers.splice(i,1);
    renderTimers();
  };

  // ‚è± Intervalo de actualizaci√≥n local
  setInterval(()=>{
    let changed=false;
    timers.forEach(t=>{
      if(t.running){
        t.elapsed++;
        if(t.elapsed>=t.target*60) t.completed=true;
        changed=true;
      }
    });
    if(changed) renderTimers();
  },1000);

  // üíæ Guardado cada 5 segundos
  setInterval(()=>{ save(); },5000);

  // üîπ Drag & Drop
  let draggedIndex = null;
  function enableDragAndDrop() {
    const container = document.getElementById("timers-container");
    const children = container.querySelectorAll(".timer");

    children.forEach(child => {
      child.ondragstart = e => {
        draggedIndex = [...children].indexOf(e.target);
      };

      child.ondragover = e => e.preventDefault();

      child.ondrop = e => {
        const targetIndex = [...children].indexOf(e.target.closest(".timer"));
        if (targetIndex === -1 || draggedIndex === null) return;
        const moved = timers.splice(draggedIndex,1)[0];
        timers.splice(targetIndex,0,moved);
        draggedIndex = null;
        save();
        renderTimers();
      };
    });
  }

  // üåÖ/üåá D√≠a y creaci√≥n de timers
  document.getElementById("startDayBtn").onclick = () => {
    if (dayStarted) return alert("El d√≠a ya est√° iniciado.");
    dayStarted = new Date().toISOString();
    save();
  };

  document.getElementById("endDayBtn").onclick = () => {
    if (!dayStarted) return alert("A√∫n no iniciaste el d√≠a.");
    dayEnded = new Date().toISOString();
    timers.forEach(t => { t.running = false; t.elapsed = 0; t.completed = false; });
    dayStarted = null;
    save(); renderTimers();
  };

  document.getElementById("addTimerBtn").onclick = () =>
    document.getElementById("formSection").classList.toggle("hidden");

  document.getElementById("createTimerBtn").onclick = () => {
    const n=document.getElementById("activityName").value.trim();
    const t=Number(document.getElementById("targetMinutes").value);
    const note=document.getElementById("note").value.trim();
    if(!n||!t) return alert("Nombre y minutos requeridos.");
    timers.push({name:n,target:t,note,elapsed:0,running:false,completed:false});
    document.getElementById("activityName").value="";
    document.getElementById("targetMinutes").value="";
    document.getElementById("note").value="";
    document.getElementById("formSection").classList.add("hidden");
    save(); renderTimers();
  };

</script>
</body>
</html>











