<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gestor de Cron√≥metros</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #101010;
    color: #eee;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
  }
  h1 { margin-bottom: 10px; }
  .controls { margin-bottom: 20px; }
  button {
    background: #2a2a2a; border: none; color: #fff;
    padding: 8px 14px; margin: 4px;
    border-radius: 6px; cursor: pointer;
    transition: background 0.3s;
  }
  button:hover { background: #444; }
  #timers-container {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 15px; width: 90%; max-width: 900px;
  }
  .timer {
    background: #1c1c1c; border: 1px solid #333;
    border-radius: 10px; padding: 10px;
    display: flex; flex-direction: column; align-items: center;
  }
  .timer.completed { background: #164d16; border-color: #1d7a1d; }
  .timer h3 { margin: 5px 0; }
  .timer p { margin: 2px 0; }
  .timer .buttons { display: flex; gap: 6px; }
  .draggable { cursor: move; }
  .input-group {
    display: flex; gap: 5px; flex-wrap: wrap;
    justify-content: center; margin-top: 8px;
  }
  input, textarea {
    padding: 6px; border-radius: 5px;
    border: 1px solid #555; background: #181818; color: #eee;
  }
  textarea { resize: vertical; }
  .hidden { display: none; }
  #userSection { margin-bottom: 20px; text-align: center; }
</style>
</head>
<body>

<h1>Gestor de Cron√≥metros</h1>

<!-- üîê Secci√≥n de login -->
<div id="userSection">
  <button id="loginBtn">üîë Iniciar con Google</button>
  <button id="logoutBtn" class="hidden">üö™ Cerrar sesi√≥n</button>
  <p id="userInfo"></p>
</div>

<div class="controls hidden" id="mainControls">
  <button id="startDayBtn">üåÖ Iniciar D√≠a</button>
  <button id="endDayBtn">üåá Finalizar D√≠a</button>
  <button id="addTimerBtn">‚ûï Nuevo Cron√≥metro</button>
</div>

<div id="formSection" class="hidden">
  <div class="input-group">
    <input type="text" id="activityName" placeholder="Nombre de la actividad">
    <input type="number" id="targetMinutes" placeholder="Minutos objetivo" min="1">
  </div>
  <div class="input-group">
    <textarea id="note" placeholder="Nota (opcional)"></textarea>
  </div>
  <button id="createTimerBtn">Crear</button>
</div>

<div id="timers-container"></div>

<!-- üî• Firebase + l√≥gica principal -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // üîß Configuraci√≥n de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCby9oxzPzBDllkzuW21ZoGNJh67UgYZ8E",
    authDomain: "notion-timers-2a3bb.firebaseapp.com",
    databaseURL: "https://notion-timers-2a3bb-default-rtdb.firebaseio.com",
    projectId: "notion-timers-2a3bb",
    storageBucket: "notion-timers-2a3bb.firebasestorage.app",
    messagingSenderId: "78500747038",
    appId: "1:78500747038:web:2b5fdec3731a203c7f1b0f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const ALLOWED_EMAILS = ["20160800armando@gmail.com"];

  let dbRef;
  let timers = [];
  let dayStarted = null;
  let dayEnded = null;
  let dragSrc = null;

  // üß† funciones de auth
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userInfo = document.getElementById("userInfo");
  const controls = document.getElementById("mainControls");

  loginBtn.onclick = async () => {
    try {
      await signInWithPopup(auth, provider);
    } catch (err) {
      alert("Error al iniciar sesi√≥n: " + err.message);
    }
  };

  logoutBtn.onclick = async () => {
    await signOut(auth);
  };

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      if (!ALLOWED_EMAILS.includes(user.email)) {
        alert("No tienes acceso autorizado.");
        await signOut(auth);
        return;
      }
      loginBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      controls.classList.remove("hidden");
      userInfo.textContent = `Conectado como: ${user.displayName}`;
      dbRef = ref(db, `usuarios/${user.uid}/cronometros/diaActual`);
      listenToData();
    } else {
      loginBtn.classList.remove("hidden");
      logoutBtn.classList.add("hidden");
      controls.classList.add("hidden");
      userInfo.textContent = "";
      timers = [];
      renderTimers();
    }
  });

  // üïì formato hh:mm:ss
  function formatTime(seconds) {
    const h = String(Math.floor(seconds / 3600)).padStart(2, "0");
    const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, "0");
    const s = String(seconds % 60).padStart(2, "0");
    return `${h}:${m}:${s}`;
  }

  // üíæ Guarda todo el estado actual en Firebase
  function saveToFirebase() {
    if (!dbRef) return;
    set(dbRef, {
      timers,
      dayStarted,
      dayEnded,
      updatedAt: new Date().toISOString(),
    });
  }

  // üîÅ Escucha cambios en tiempo real desde Firebase
  function listenToData() {
    onValue(dbRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        timers = data.timers || [];
        dayStarted = data.dayStarted || null;
        dayEnded = data.dayEnded || null;
        renderTimers();
      }
    });
  }

  // üß± renderiza cron√≥metros
  function renderTimers() {
    const container = document.getElementById("timers-container");
    container.innerHTML = "";
    timers.forEach((t, index) => {
      const div = document.createElement("div");
      div.className = "timer draggable" + (t.completed ? " completed" : "");
      div.draggable = true;

      div.innerHTML = `
        <h3>${t.name}</h3>
        <p>Objetivo: ${t.target} min</p>
        <p>Tiempo: <span>${formatTime(t.elapsed)}</span></p>
        ${t.note ? `<p><i>${t.note}</i></p>` : ""}
        <div class="buttons">
          <button onclick="toggleTimer(${index})">${t.running ? "‚è∏Ô∏è Pausa" : "‚ñ∂Ô∏è Iniciar"}</button>
          <button onclick="resetTimer(${index})">üîÑ Reset</button>
          <button onclick="deleteTimer(${index})">üóëÔ∏è Borrar</button>
        </div>
      `;

      div.addEventListener("dragstart", e => (dragSrc = index));
      div.addEventListener("dragover", e => e.preventDefault());
      div.addEventListener("drop", e => {
        e.preventDefault();
        if (dragSrc !== index) {
          const temp = timers[dragSrc];
          timers.splice(dragSrc, 1);
          timers.splice(index, 0, temp);
          renderTimers();
          saveToFirebase();
        }
      });

      container.appendChild(div);
    });
  }

  // üïπÔ∏è Control de cron√≥metros
  window.toggleTimer = (i) => {
    if (!dayStarted) return alert("Debes iniciar el d√≠a antes de activar los cron√≥metros.");
    timers[i].running = !timers[i].running;
    renderTimers(); saveToFirebase();
  };
  window.resetTimer = (i) => {
    timers[i].elapsed = 0; timers[i].running = false; timers[i].completed = false;
    renderTimers(); saveToFirebase();
  };
  window.deleteTimer = (i) => {
    timers.splice(i, 1); renderTimers(); saveToFirebase();
  };

  setInterval(() => {
    let updated = false;
    timers.forEach(t => {
      if (t.running) {
        t.elapsed++;
        updated = true;
        if (t.elapsed >= t.target * 60 && !t.completed) t.completed = true;
      }
    });
    if (updated) saveToFirebase();
    renderTimers();
  }, 1000);

  // üìÜ Control del d√≠a
  document.getElementById("startDayBtn").onclick = () => {
    if (dayStarted) return alert("El d√≠a ya ha comenzado.");
    dayStarted = new Date().toISOString();
    alert(`D√≠a iniciado: ${new Date(dayStarted).toLocaleString()}`);
    saveToFirebase();
  };
  document.getElementById("endDayBtn").onclick = () => {
    if (!dayStarted) return alert("El d√≠a no ha comenzado a√∫n.");
    dayEnded = new Date().toISOString();
    timers.forEach(t => { t.running = false; t.elapsed = 0; t.completed = false; });
    alert(`D√≠a finalizado: ${new Date(dayEnded).toLocaleString()}`);
    dayStarted = null;
    renderTimers(); saveToFirebase();
  };

  // ‚ûï Crear nuevo cron√≥metro
  document.getElementById("addTimerBtn").onclick = () => {
    document.getElementById("formSection").classList.toggle("hidden");
  };
  document.getElementById("createTimerBtn").onclick = () => {
    const name = document.getElementById("activityName").value.trim();
    const target = Number(document.getElementById("targetMinutes").value);
    const note = document.getElementById("note").value.trim();
    if (!name || !target) return alert("Debes ingresar nombre y tiempo objetivo.");
    timers.push({ name, target, note, elapsed: 0, running: false, completed: false });
    document.getElementById("activityName").value = "";
    document.getElementById("targetMinutes").value = "";
    document.getElementById("note").value = "";
    document.getElementById("formSection").classList.add("hidden");
    renderTimers(); saveToFirebase();
  };

  renderTimers();
</script>
</body>
</html>


