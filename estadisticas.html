<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Estad√≠sticas Generales</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Segoe UI, sans-serif;
  background: #ececec;
  padding: 20px;
}
h1, h2 { color:#222; }
.card {
  background: white;
  padding:15px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
  margin-bottom:20px;
}
#filters {
  display:flex;
  gap:10px;
  margin-bottom:20px;
}
select { padding:6px; }
table {
  border-collapse: collapse;
  width: 100%;
}
th, td {
  border-bottom:1px solid #ccc;
  padding:6px;
}
</style>
</head>

<body>
<h1>üìä Estad√≠sticas Generales</h1>

<div class="card">
  <h2>Filtros</h2>
  <div id="filters">
    <select id="filterDia"></select>
    <select id="filterFecha"></select>
  </div>
</div>

<div class="card">
  <h2>Resumen General</h2>
  <div id="resumen"></div>
</div>

<div class="card">
  <h2>Tiempo por Cron√≥metro</h2>
  <canvas id="chartActividades"></canvas>
</div>

<div class="card">
  <h2>Tiempo por D√≠a</h2>
  <canvas id="chartDias"></canvas>
</div>

<div class="card">
  <h2>Sesiones de trabajo</h2>
  <table>
    <thead>
      <tr>
        <th>Actividad</th>
        <th>D√≠a</th>
        <th>Fecha</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Duraci√≥n</th>
      </tr>
    </thead>
    <tbody id="tablaSesiones"></tbody>
  </table>
</div>

<script>
// ============================
//  1. Cargar datos
// ============================
const data = localStorage.getItem("registroProcesado");
if (!data) {
    document.body.innerHTML = "<h2>No se encontraron datos (registroProcesado). Abra desde index.html</h2>";
    throw new Error("No hay datos");
}

const registro = JSON.parse(data);
const sessionsRaw = registro.sessions || [];
const timersMeta = registro.timersMeta || {};
const diasRegistro = registro.dias || [];

// ============================
//  2. Normalizar sesiones
// ============================
const sessions = sessionsRaw.map(s => {
    const duration = Math.max(0, (Number(s.endElapsed) || 0) - (Number(s.startElapsed) || 0));

    return {
        ...s,
        durationSec: duration,
        timerId: s.timerId,
        name: s.name,
        dia: s.dia,
        dateKey: s.dateKey,
        startTs: s.startTs,
        endTs: s.endTs
    };
});

// ============================
//  3. Construir metaPorTimerId
// ============================
const metaPorTimerId = {};
for (const tid in timersMeta) {
    const m = timersMeta[tid];
    metaPorTimerId[tid] = {
        name: m.name || "(sin nombre)",
        targetMin: Number(m.target || 0),
        createdAt: m.createdAt
    };
}

// ============================
//  4. Filtros
// ============================
const filterDia = document.getElementById("filterDia");
const filterFecha = document.getElementById("filterFecha");

filterDia.innerHTML = `<option value="">Todos los d√≠as</option>`;
diasRegistro.forEach(d => {
    filterDia.innerHTML += `<option value="${d.dia}">D√≠a ${d.dia}</option>`;
});

const fechasUnicas = [...new Set(sessions.map(s => s.dateKey))];
filterFecha.innerHTML = `<option value="">Todas las fechas</option>`;
fechasUnicas.forEach(f => {
    filterFecha.innerHTML += `<option value="${f}">${f}</option>`;
});

filterDia.onchange = renderTodo;
filterFecha.onchange = renderTodo;

// ============================
//  5. Helper: formateo
// ============================
function formatSec(s) {
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${h}h ${m}m ${ss}s`;
}

function filtrarSesiones() {
    const d = filterDia.value;
    const f = filterFecha.value;
    return sessions.filter(s => {
        if (d && String(s.dia) !== d) return false;
        if (f && s.dateKey !== f) return false;
        return true;
    });
}

// ============================
//  6. Tabla con objetivo y cumplimiento
// ============================
function renderTabla(ss) {
    const tbody = document.getElementById("tablaSesiones");
    tbody.innerHTML = "";

    const acumulado = {};  // por timerId

    ss.forEach(s => {
        const tid = s.timerId;
        const meta = metaPorTimerId[tid] || { targetMin: 0, name: s.name };

        acumulado[tid] = (acumulado[tid] || 0) + s.durationSec;

        const objetivoSec = meta.targetMin * 60;
        const cumplido = acumulado[tid] >= objetivoSec ? "‚úî" : "‚úñ";

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${s.name}</td>
            <td>${s.dia}</td>
            <td>${s.dateKey}</td>
            <td>${new Date(s.startTs).toLocaleString()}</td>
            <td>${new Date(s.endTs).toLocaleString()}</td>
            <td>${formatSec(s.durationSec)}</td>
            <td>${meta.targetMin}</td>
            <td>${cumplido}</td>
        `;
        tbody.appendChild(tr);
    });
}

// ============================
//  7. Racha correcta
// ============================
function calcularRacha() {
    const trabajPorDia = {};  
    const timersPorDia = {};  

    sessions.forEach(s => {
        if (s.dia == null) return;

        trabajPorDia[s.dia] = (trabajPorDia[s.dia] || 0) + s.durationSec;

        timersPorDia[s.dia] = timersPorDia[s.dia] || new Set();
        timersPorDia[s.dia].add(s.timerId);
    });

    const objetivosPorDia = {};
    for (const dia in timersPorDia) {
        let total = 0;
        for (const tid of timersPorDia[dia]) {
            const meta = metaPorTimerId[tid];
            if (!meta) continue;
            total += meta.targetMin * 60;
        }
        objetivosPorDia[dia] = total;
    }

    const diasOrd = Object.keys(trabajPorDia).map(Number).sort((a,b)=>a-b);

    let max = 0, streak = 0, last = null;

    diasOrd.forEach(d => {
        const t = trabajPorDia[d];
        const o = objetivosPorDia[d] || 0;

        const cumplido = (o > 0 && t >= o);

        if (last === null || d === last + 1) {
            streak = cumplido ? streak + 1 : 0;
        } else {
            streak = cumplido ? 1 : 0;
        }

        max = Math.max(max, streak);
        last = d;
    });

    return max;
}

// ============================
//  8. Resumen
// ============================
function renderResumen(ss) {
    const total = ss.reduce((a,b)=>a+b.durationSec, 0);
    const diasSet = new Set(ss.map(s => s.dia));
    const fechasSet = new Set(ss.map(s => s.dateKey));

    const racha = calcularRacha();

    document.getElementById("resumen").innerHTML = `
        <p><b>Tiempo total:</b> ${formatSec(total)}</p>
        <p><b>D√≠as trabajados:</b> ${diasSet.size}</p>
        <p><b>Fechas √∫nicas:</b> ${fechasSet.size}</p>
        <p><b>Racha de d√≠as cumplidos:</b> ${racha}</p>
    `;
}

// ============================
//  9. Gr√°ficos
// ============================
let chartAct = null, chartDias = null;

function renderChartActividades(ss) {
    const acc = {};
    ss.forEach(s => {
        acc[s.name] = (acc[s.name] || 0) + s.durationSec;
    });

    const labels = Object.keys(acc);
    const values = Object.values(acc);

    if (chartAct) chartAct.destroy();

    chartAct = new Chart(document.getElementById("chartActividades"),{
        type:"bar",
        data:{ labels, datasets:[{ label:"Segundos", data:values }] }
    });
}

function renderChartDias(ss) {
    const acc = {};
    ss.forEach(s => {
        acc[s.dia] = (acc[s.dia] || 0) + s.durationSec;
    });

    const labels = Object.keys(acc).map(d => "D√≠a " + d);
    const values = Object.values(acc);

    if (chartDias) chartDias.destroy();

    chartDias = new Chart(document.getElementById("chartDias"),{
        type:"line",
        data:{ labels, datasets:[{ label:"Segundos", data:values, tension:0.25 }] }
    });
}

// ============================
//  10. Render final
// ============================
function renderTodo() {
    const ss = filtrarSesiones();
    renderResumen(ss);
    renderTabla(ss);
    renderChartActividades(ss);
    renderChartDias(ss);
}

renderTodo();

</script>




</body>
</html>







