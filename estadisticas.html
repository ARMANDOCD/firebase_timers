<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Estad√≠sticas</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Segoe UI, sans-serif; padding: 20px; background: #fafafa; color:#111; }
  .card{ background:#fff; padding:16px; border-radius:12px; margin-bottom:18px; box-shadow:0 2px 10px rgba(0,0,0,0.08); }
  h1,h2{ margin:0 0 10px; }
  select,input{ padding:6px; border:1px solid #ccc; border-radius:6px; }
  table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; }
  th,td{ border-bottom:1px solid #eee; padding:8px; }
  .small{ font-size:12px; color:#666; }
  #filters{ display:flex; gap:10px; flex-wrap:wrap; }
</style>
</head>
<body>

<h1>üìä Estad√≠sticas ‚Äî Registro Procesado (Index)</h1>

<div id="status" class="small" style="margin-bottom:15px;"></div>

<div class="card">
  <h3>Filtros</h3>
  <div id="filters">
     <select id="filterDia"><option value="">Todos los d√≠as</option></select>
     <select id="filterFecha"><option value="">Todas las fechas</option></select>
     <input id="filterName" placeholder="Buscar actividad"/>
     <button id="refreshBtn">üîÅ Refrescar</button>
  </div>
</div>

<div class="card">
  <h3>Resumen</h3>
  <div id="resumen"></div>
</div>

<div class="card">
  <h3>Tiempo por Actividad</h3>
  <canvas id="grafActividades" height="150"></canvas>
</div>

<div class="card">
  <h3>Tiempo por D√≠a</h3>
  <canvas id="grafDias" height="150"></canvas>
</div>

<div class="card">
  <h3>Sesiones</h3>
  <table>
    <thead>
      <tr>
        <th>Actividad</th>
        <th>D√≠a</th>
        <th>Fecha</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Duraci√≥n</th>
        <th>Objetivo (min)</th>
        <th>Cumplido</th>
      </tr>
    </thead>
    <tbody id="tablaSesiones"></tbody>
  </table>
</div>

<script>
/* ==========================================================
   CARGAR registroProcesado DESDE LOCALSTORAGE
   ========================================================== */

let registro = null;
const status = document.getElementById("status");

function cargarRegistroProcesado() {
    const raw = localStorage.getItem("registroProcesado");
    if(!raw){
        status.textContent = "‚ö† No hay datos. Primero abre la app principal y pulsa 'Estad√≠sticas Generales'.";
        return null;
    }
    try {
        const r = JSON.parse(raw);
        status.textContent = "Datos cargados correctamente.";
        console.log("registroProcesado:", r);
        return r;
    } catch(e){
        status.textContent = "‚ö† Error leyendo datos.";
        return null;
    }
}

registro = cargarRegistroProcesado();
if(!registro) return;

/* ==========================================================
   DESGLOSE DE DATOS
   ========================================================== */

const dias = registro.dias || [];
const sessions = registro.sessions || [];
const timersMeta = registro.timersMeta || {};

/* ==========================================================
   RENDER FILTROS
   ========================================================== */

function renderFiltros() {
    const fDia = document.getElementById("filterDia");
    fDia.innerHTML = `<option value="">Todos los d√≠as</option>`;
    dias.forEach(d => {
        fDia.innerHTML += `<option value="${d.dia}">D√≠a ${d.dia}</option>`;
    });

    const fechas = [...new Set(sessions.map(s => s.dateKey).filter(x => x))].sort();
    const fFecha = document.getElementById("filterFecha");
    fFecha.innerHTML = `<option value="">Todas las fechas</option>`;
    fechas.forEach(f => {
        fFecha.innerHTML += `<option value="${f}">${f}</option>`;
    });
}

renderFiltros();

/* ==========================================================
   FILTRAR SESIONES
   ========================================================== */

function filtrarSesiones() {
    const d = document.getElementById("filterDia").value;
    const f = document.getElementById("filterFecha").value;
    const q = document.getElementById("filterName").value.trim().toLowerCase();

    return sessions.filter(s => {
        if(d && String(s.dia) !== d) return false;
        if(f && s.dateKey !== f) return false;
        if(q && (!s.name || !s.name.toLowerCase().includes(q))) return false;
        return true;
    });
}

/* ==========================================================
   UTIL
   ========================================================== */

function formatSec(sec){
    sec = Number(sec||0);
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = sec%60;
    return `${h}h ${m}m ${s}s`;
}

/* ==========================================================
   RENDER TABLA
   ========================================================== */

function renderTabla() {
    const lista = filtrarSesiones();
    const tbody = document.getElementById("tablaSesiones");
    tbody.innerHTML = "";

    const acumulado = {};

    lista.forEach(s => {
        acumulado[s.timerId] = (acumulado[s.timerId] || 0) + s.durationSec;

        const meta = timersMeta[s.timerId] || {};
        const objetivoMin = Number(meta.target || 0);
        const objetivoSec = objetivoMin * 60;
        const cumplido = objetivoSec ? (acumulado[s.timerId] >= objetivoSec ? "‚úî" : "‚úñ") : "‚Äî";

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${s.name || meta.name || s.timerId}</td>
            <td>${s.dia || ""}</td>
            <td>${s.dateKey || ""}</td>
            <td>${new Date(s.startTs).toLocaleString()}</td>
            <td>${new Date(s.endTs).toLocaleString()}</td>
            <td>${formatSec(s.durationSec)}</td>
            <td>${objetivoMin}</td>
            <td>${cumplido}</td>
        `;
        tbody.appendChild(tr);
    });
}

/* ==========================================================
   RESUMEN / RACHAS
   ========================================================== */

function calcularResumen() {
    const lista = filtrarSesiones();

    const total = lista.reduce((a,b)=>a+b.durationSec,0);
    const diasUsados = new Set(lista.map(s=>s.dia).filter(Boolean));
    const fechasUsadas = new Set(lista.map(s=>s.dateKey).filter(Boolean));

    // Rachas: d√≠a cumplido si suma_duraciones >= suma_objetivos
    const durPorDia = {};
    const objPorDia = {};

    lista.forEach(s => {
        if(!s.dia) return;
        durPorDia[s.dia] = (durPorDia[s.dia] || 0) + s.durationSec;

        const meta = timersMeta[s.timerId];
        if(meta){
            objPorDia[s.dia] = (objPorDia[s.dia] || 0) + (Number(meta.target || 0) * 60);
        }
    });

    const diasOrdenados = Object.keys(durPorDia).map(Number).sort((a,b)=>a-b);

    let racha = 0, rachaMax = 0;

    diasOrdenados.forEach(d => {
        const cumplido = durPorDia[d] >= (objPorDia[d] || 0);
        if(cumplido) racha++;
        else racha = 0;
        rachaMax = Math.max(rachaMax, racha);
    });

    const r = document.getElementById("resumen");
    r.innerHTML = `
       <p><b>Total trabajado:</b> ${formatSec(total)}</p>
       <p><b>D√≠as activos:</b> ${diasUsados.size}</p>
       <p><b>Fechas √∫nicas:</b> ${fechasUsadas.size}</p>
       <p><b>Racha m√°xima:</b> ${rachaMax}</p>
    `;
}

/* ==========================================================
   GRAFICAS
   ========================================================== */

let chartAct = null;
let chartDia = null;

function renderGraficos() {
    const lista = filtrarSesiones();

    const aggAct = {};
    const aggDia = {};

    lista.forEach(s => {
        aggAct[s.name] = (aggAct[s.name] || 0) + s.durationSec;
        aggDia[s.dia] = (aggDia[s.dia] || 0) + s.durationSec;
    });

    // actividad
    if(chartAct) chartAct.destroy();
    chartAct = new Chart(document.getElementById("grafActividades"), {
        type: "bar",
        data: {
            labels: Object.keys(aggAct),
            datasets: [{
                label: "Segundos",
                data: Object.values(aggAct)
            }]
        }
    });

    // dia
    if(chartDia) chartDia.destroy();
    chartDia = new Chart(document.getElementById("grafDias"), {
        type: "line",
        data: {
            labels: Object.keys(aggDia).map(d => "D√≠a " + d),
            datasets: [{
                label: "Segundos",
                data: Object.values(aggDia),
                tension: 0.2
            }]
        }
    });
}

/* ==========================================================
   REFRESCAR TODO
   ========================================================== */

function refrescarTodo() {
    renderTabla();
    calcularResumen();
    renderGraficos();
}

document.getElementById("refreshBtn").onclick = refrescarTodo;
document.getElementById("filterDia").onchange = refrescarTodo;
document.getElementById("filterFecha").onchange = refrescarTodo;
document.getElementById("filterName").oninput = refrescarTodo;

refrescarTodo();

</script>
</body>
</html>











