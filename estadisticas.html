<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Estad√≠sticas Generales</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Segoe UI, sans-serif;
  background: #ececec;
  padding: 20px;
}

h1, h2 { color:#222; }
.card {
  background: white;
  padding:15px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
  margin-bottom:20px;
}

#filters {
  display:flex;
  gap:10px;
  margin-bottom:20px;
}
select { padding:6px; }

table {
  border-collapse: collapse;
  width: 100%;
}
th, td {
  border-bottom:1px solid #ccc;
  padding:6px;
}
</style>
</head>

<body>
<h1>üìä Estad√≠sticas Generales</h1>

<div class="card">
  <h2>Filtros</h2>
  <div id="filters">
    <select id="filterDia"></select>
    <select id="filterFecha"></select>
  </div>
</div>

<div class="card">
  <h2>Resumen General</h2>
  <div id="resumen"></div>
</div>

<div class="card">
  <h2>Tiempo por Cron√≥metro</h2>
  <canvas id="chartActividades"></canvas>
</div>

<div class="card">
  <h2>Tiempo por D√≠a</h2>
  <canvas id="chartDias"></canvas>
</div>

<div class="card">
  <h2>Sesiones de trabajo</h2>
  <table>
    <thead>
      <tr>
        <th>Actividad</th>
        <th>D√≠a</th>
        <th>Fecha</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Duraci√≥n</th>
      </tr>
    </thead>
    <tbody id="tablaSesiones"></tbody>
  </table>
</div>

<script>
/* Esperamos a que index.html nos pase los datos */
window.addEventListener("registroProcesadoReady", e => {
    const data = e.detail;
    iniciarEstadisticas(data);
});

function formatSec(s){
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const ss = s%60;
  return `${h}h ${m}m ${ss}s`;
}

function iniciarEstadisticas(reg){

    const dias = reg.dias;
    const sessions = reg.sessions;
    const timersMeta = reg.timersMeta;

    /* -------------------------
       GENERAR LISTAS DE FILTRO
    --------------------------*/
    const filterDia = document.getElementById("filterDia");
    const filterFecha = document.getElementById("filterFecha");

    filterDia.innerHTML = `<option value="">Todos los d√≠as</option>`;
    dias.forEach(d => {
        filterDia.innerHTML += `<option value="${d.dia}">D√≠a ${d.dia}</option>`;
    });

    const fechasUnicas = [...new Set(sessions.map(s => s.dateKey))];
    filterFecha.innerHTML = `<option value="">Todas las fechas</option>`;
    fechasUnicas.forEach(f => {
        filterFecha.innerHTML += `<option value="${f}">${f}</option>`;
    });

    filterDia.onchange = () => renderTodo();
    filterFecha.onchange = () => renderTodo();

    function filtrarSesiones(){
        const d = filterDia.value;
        const f = filterFecha.value;

        return sessions.filter(s => {
            if(d && s.dia != d) return false;
            if(f && s.dateKey != f) return false;
            return true;
        });
    }

    /* ----------------------------------------
        RENDER PRINCIPAL
    -----------------------------------------*/
    function renderTodo(){
        const ss = filtrarSesiones();

        renderResumen(ss);
        renderTabla(ss);
        renderChartActividades(ss);
        renderChartDias(ss);
    }

    /* ----------------------------------------
        RESUMEN GENERAL
    -----------------------------------------*/
    function renderResumen(ss){
        const res = document.getElementById("resumen");

        const total = ss.reduce((a,b)=>a+b.durationSec,0);
        const diasSet = new Set(ss.map(s=>s.dia));
        const fechasSet = new Set(ss.map(s=>s.dateKey));

        // racha de d√≠as consecutivos
        const sorted = [...diasSet].sort((a,b)=>a-b);
        let maxRacha = 1, actual = 1;
        for(let i=1;i<sorted.length;i++){
            if(sorted[i] == sorted[i-1]+1) actual++;
            else { maxRacha = Math.max(maxRacha, actual); actual=1; }
        }
        maxRacha = Math.max(maxRacha, actual);

        res.innerHTML = `
          <p><b>Tiempo total:</b> ${formatSec(total)}</p>
          <p><b>Total d√≠as trabajados:</b> ${diasSet.size}</p>
          <p><b>Total fechas registradas:</b> ${fechasSet.size}</p>
          <p><b>Racha m√°xima:</b> ${maxRacha} d√≠as consecutivos</p>
        `;
    }

    /* ----------------------------------------
        TABLA DE SESIONES
    -----------------------------------------*/
    function renderTabla(ss){
        const body = document.getElementById("tablaSesiones");
        body.innerHTML = "";

        ss.forEach(s => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${s.name}</td>
              <td>${s.dia}</td>
              <td>${s.dateKey}</td>
              <td>${new Date(s.startTs).toLocaleString()}</td>
              <td>${new Date(s.endTs).toLocaleString()}</td>
              <td>${formatSec(s.durationSec)}</td>
            `;
            body.appendChild(tr);
        });
    }

    /* ----------------------------------------
        GR√ÅFICO: TIEMPO POR CRON√ìMETRO
    -----------------------------------------*/
    let chartAct = null;
    function renderChartActividades(ss){
        const acumulado = {};
        ss.forEach(s=>{
            if(!acumulado[s.name]) acumulado[s.name]=0;
            acumulado[s.name]+=s.durationSec;
        });

        const labels = Object.keys(acumulado);
        const values = Object.values(acumulado);

        if(chartAct) chartAct.destroy();
        const ctx = document.getElementById("chartActividades");

        chartAct = new Chart(ctx,{
            type:"bar",
            data:{
                labels,
                datasets:[{
                    label:"Segundos trabajados",
                    data:values
                }]
            }
        });
    }

    /* ----------------------------------------
        GR√ÅFICO: TIEMPO POR D√çA
    -----------------------------------------*/
    let chartDias = null;
    function renderChartDias(ss){
        const acumulado = {};
        ss.forEach(s=>{
            if(!acumulado[s.dia]) acumulado[s.dia]=0;
            acumulado[s.dia]+=s.durationSec;
        });

        const labels = Object.keys(acumulado).map(d=>"D√≠a "+d);
        const values = Object.values(acumulado);

        if(chartDias) chartDias.destroy();
        const ctx = document.getElementById("chartDias");

        chartDias = new Chart(ctx,{
            type:"line",
            data:{
                labels,
                datasets:[{
                    label:"Segundos trabajados",
                    data:values,
                    tension:0.3
                }]
            }
        });
    }

    renderTodo();
}
</script>
</body>
</html>


generarEstadisticas();
</script>
</body>

</html>
