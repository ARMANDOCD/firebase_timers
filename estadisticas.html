<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Estad√≠sticas Generales</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Segoe UI, sans-serif;
  background: #ececec;
  padding: 20px;
}
h1, h2 { color:#222; }
.card {
  background: white;
  padding:15px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
  margin-bottom:20px;
}
#filters {
  display:flex;
  gap:10px;
  margin-bottom:20px;
}
select { padding:6px; }
table {
  border-collapse: collapse;
  width: 100%;
}
th, td {
  border-bottom:1px solid #ccc;
  padding:6px;
}
</style>
</head>

<body>
<h1>üìä Estad√≠sticas Generales</h1>

<div class="card">
  <h2>Filtros</h2>
  <div id="filters">
    <select id="filterDia"></select>
    <select id="filterFecha"></select>
  </div>
</div>

<div class="card">
  <h2>Resumen General</h2>
  <div id="resumen"></div>
</div>

<div class="card">
  <h2>Tiempo por Cron√≥metro</h2>
  <canvas id="chartActividades"></canvas>
</div>

<div class="card">
  <h2>Tiempo por D√≠a</h2>
  <canvas id="chartDias"></canvas>
</div>

<div class="card">
  <h2>Sesiones de trabajo</h2>
  <table>
    <thead>
      <tr>
        <th>Actividad</th>
        <th>D√≠a</th>
        <th>Fecha</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Duraci√≥n</th>
      </tr>
    </thead>
    <tbody id="tablaSesiones"></tbody>
  </table>
</div>

<script>
/* ================================
   1. Cargar registro desde localStorage
================================ */
const data = localStorage.getItem("registroProcesado");

if (!data) {
    document.body.innerHTML = "<h2>No se encontraron datos (registroProcesado). Abra desde index.html</h2>";
    throw new Error("Sin datos");
}

const registro = JSON.parse(data);
const dias = registro.dias;
const sessions = registro.sessions;
const timersMeta = registro.timersMeta;

/* ================================
   2. Procesar objetivos y acumulados
================================ */

/* 2.1 Agrupar tiempo trabajado por timer */
const tiempoPorTimer = {};
sessions.forEach(s => {
    if (!tiempoPorTimer[s.timerId]) tiempoPorTimer[s.timerId] = 0;
    tiempoPorTimer[s.timerId] += s.durationSec;
});

/* 2.2 Determinar cumplimiento por actividad */
const cumplimientoPorTimer = {};
for (const timerId in timersMeta) {
    const objetivoMin = timersMeta[timerId].target || 0;
    const objetivoSec = objetivoMin * 60;
    const trabajado = tiempoPorTimer[timerId] || 0;
    cumplimientoPorTimer[timerId] = trabajado >= objetivoSec;
}

/* ================================
   3. Racha basada en objetivos diarios
================================ */
function calcularRachaDias() {
    const diasAgrupados = {};

    sessions.forEach(s => {
        if (!diasAgrupados[s.dia]) diasAgrupados[s.dia] = 0;
        diasAgrupados[s.dia] += s.durationSec;
    });

    const objetivosPorDia = {};
    dias.forEach(d => {
        objetivosPorDia[d.dia] = 0;
        for (const timerId in timersMeta) {
            const objetivo = timersMeta[timerId].target || 0;
            objetivosPorDia[d.dia] += objetivo * 60;
        }
    });

    let racha = 0, maxRacha = 0;

    const ordenados = Object.keys(diasAgrupados)
        .map(n => Number(n))
        .sort((a, b) => a - b);

    for (let i = 0; i < ordenados.length; i++) {
        const dia = ordenados[i];
        const cumplido = diasAgrupados[dia] >= objetivosPorDia[dia];

        if (cumplido) {
            racha++;
            maxRacha = Math.max(maxRacha, racha);
        } else racha = 0;
    }

    return maxRacha;
}

/* ================================
   4. Inicializar filtros
================================ */
const filterDia = document.getElementById("filterDia");
const filterFecha = document.getElementById("filterFecha");

filterDia.innerHTML = `<option value="">Todos los d√≠as</option>`;
dias.forEach(d => filterDia.innerHTML += `<option value="${d.dia}">D√≠a ${d.dia}</option>`);

const fechasUnicas = [...new Set(sessions.map(s => s.dateKey))];
filterFecha.innerHTML = `<option value="">Todas las fechas</option>`;
fechasUnicas.forEach(f => filterFecha.innerHTML += `<option value="${f}">${f}</option>`);

filterDia.onchange = renderTodo;
filterFecha.onchange = renderTodo;

/* ================================
   5. Filtrado
================================ */
function filtrarSesiones() {
    const d = filterDia.value;
    const f = filterFecha.value;
    return sessions.filter(s => {
        if (d && s.dia != d) return false;
        if (f && s.dateKey != f) return false;
        return true;
    });
}

function formatSec(s) {
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const ss = s % 60;
    return `${h}h ${m}m ${ss}s`;
}

/* ================================
   6. RESUMEN (con racha correcta)
================================ */
function renderResumen(ss) {
    const total = ss.reduce((a, b) => a + b.durationSec, 0);
    const diasSet = new Set(ss.map(s => s.dia));
    const fechasSet = new Set(ss.map(s => s.dateKey));

    const racha = calcularRachaDias();

    document.getElementById("resumen").innerHTML = `
        <p><b>Tiempo total:</b> ${formatSec(total)}</p>
        <p><b>D√≠as trabajados:</b> ${diasSet.size}</p>
        <p><b>Fechas √∫nicas:</b> ${fechasSet.size}</p>
        <p><b>Racha de d√≠as cumplidos:</b> ${racha}</p>
    `;
}

/* ================================
   7. TABLA (incluye objetivo y cumplido)
================================ */
function renderTabla(ss) {
    const tbody = document.getElementById("tablaSesiones");
    tbody.innerHTML = "";

    ss.forEach(s => {
        const meta = timersMeta[s.timerId];
        const objetivo = meta ? meta.target : 0;
        const cumplido = cumplimientoPorTimer[s.timerId] ? "‚úî" : "‚úñ";

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${s.name}</td>
            <td>${s.dia}</td>
            <td>${s.dateKey}</td>
            <td>${new Date(s.startTs).toLocaleString()}</td>
            <td>${new Date(s.endTs).toLocaleString()}</td>
            <td>${formatSec(s.durationSec)}</td>
            <td>${objetivo}</td>
            <td>${cumplido}</td>
        `;
        tbody.appendChild(tr);
    });
}

/* ================================
   8. GR√ÅFICOS
================================ */

let chartAct = null;
let chartDias = null;

function renderChartActividades(ss) {
    const acc = {};
    ss.forEach(s => {
        if (!acc[s.name]) acc[s.name] = 0;
        acc[s.name] += s.durationSec;
    });

    const labels = Object.keys(acc);
    const values = Object.values(acc);

    if (chartAct) chartAct.destroy();
    chartAct = new Chart(document.getElementById("chartActividades"), {
        type: "bar",
        data: { labels, datasets: [{ label: "Segundos", data: values }] }
    });
}

function renderChartDias(ss) {
    const acc = {};
    ss.forEach(s => {
        if (!acc[s.dia]) acc[s.dia] = 0;
        acc[s.dia] += s.durationSec;
    });

    const labels = Object.keys(acc).map(d => "D√≠a " + d);
    const values = Object.values(acc);

    if (chartDias) chartDias.destroy();
    chartDias = new Chart(document.getElementById("chartDias"), {
        type: "line",
        data: { labels, datasets: [{ label: "Segundos", data: values, tension: 0.3 }] }
    });
}

/* ================================
   9. Render completo
================================ */
function renderTodo() {
    const ss = filtrarSesiones();
    renderResumen(ss);
    renderTabla(ss);
    renderChartActividades(ss);
    renderChartDias(ss);
}

renderTodo();
</script>


</body>
</html>





