<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Estad칤sticas Generales</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Segoe UI, sans-serif;
  background: #ececec;
  padding: 20px;
}
h1, h2 { color:#222; }
.card {
  background: white;
  padding:15px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
  margin-bottom:20px;
}
#filters {
  display:flex;
  gap:10px;
  margin-bottom:20px;
}
select { padding:6px; }
table {
  border-collapse: collapse;
  width: 100%;
}
th, td {
  border-bottom:1px solid #ccc;
  padding:6px;
}
</style>
</head>

<body>
<h1>游늵 Estad칤sticas Generales</h1>

<div class="card">
  <h2>Filtros</h2>
  <div id="filters">
    <select id="filterDia"></select>
    <select id="filterFecha"></select>
  </div>
</div>

<div class="card">
  <h2>Resumen General</h2>
  <div id="resumen"></div>
</div>

<div class="card">
  <h2>Tiempo por Cron칩metro</h2>
  <canvas id="chartActividades"></canvas>
</div>

<div class="card">
  <h2>Tiempo por D칤a</h2>
  <canvas id="chartDias"></canvas>
</div>

<div class="card">
  <h2>Sesiones de trabajo</h2>
  <table>
    <thead>
      <tr>
        <th>Actividad</th>
        <th>D칤a</th>
        <th>Fecha</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Duraci칩n</th>
      </tr>
    </thead>
    <tbody id="tablaSesiones"></tbody>
  </table>
</div>

<script>
/* ================================
   1. Cargar registro desde localStorage
================================ */
const data = localStorage.getItem("registroProcesado");

if (!data) {
    document.body.innerHTML = "<h2>No se encontraron datos (registroProcesado). Abra desde index.html</h2>";
    throw new Error("Sin datos");
}

const registro = JSON.parse(data);
const dias = registro.dias;
const sessions = registro.sessions;

/* ================================
   2. Inicializar filtros
================================ */
const filterDia = document.getElementById("filterDia");
const filterFecha = document.getElementById("filterFecha");

filterDia.innerHTML = `<option value="">Todos los d칤as</option>`;
dias.forEach(d => filterDia.innerHTML += `<option value="${d.dia}">D칤a ${d.dia}</option>`);

const fechasUnicas = [...new Set(sessions.map(s => s.dateKey))];

filterFecha.innerHTML = `<option value="">Todas las fechas</option>`;
fechasUnicas.forEach(f => filterFecha.innerHTML += `<option value="${f}">${f}</option>`);

filterDia.onchange = renderTodo;
filterFecha.onchange = renderTodo;

/* ================================
   3. Funciones de filtrado
================================ */
function filtrarSesiones(){
    const d = filterDia.value;
    const f = filterFecha.value;
    return sessions.filter(s => {
        if (d && s.dia != d) return false;
        if (f && s.dateKey != f) return false;
        return true;
    });
}

function formatSec(s){
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${h}h ${m}m ${ss}s`;
}

/* ================================
   4. Render RESUMEN
================================ */
function renderResumen(ss){
    const total = ss.reduce((a,b)=>a+b.durationSec,0);
    const diasSet = new Set(ss.map(s=>s.dia));
    const fechasSet = new Set(ss.map(s=>s.dateKey));

    // Racha
    const sorted = [...diasSet].sort((a,b)=>a-b);
    let maxRacha=1, actual=1;
    for(let i=1;i<sorted.length;i++){
        if(sorted[i] == sorted[i-1] + 1) actual++;
        else { maxRacha = Math.max(maxRacha, actual); actual = 1; }
    }
    maxRacha = Math.max(maxRacha, actual);

    document.getElementById("resumen").innerHTML = `
        <p><b>Tiempo total:</b> ${formatSec(total)}</p>
        <p><b>D칤as trabajados:</b> ${diasSet.size}</p>
        <p><b>Fechas 칰nicas:</b> ${fechasSet.size}</p>
        <p><b>Racha m치xima:</b> ${maxRacha} d칤as</p>
    `;
}

/* ================================
   5. Render TABLA
================================ */
function renderTabla(ss){
    const tbody = document.getElementById("tablaSesiones");
    tbody.innerHTML = "";
    ss.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${s.name}</td>
            <td>${s.dia}</td>
            <td>${s.dateKey}</td>
            <td>${new Date(s.startTs).toLocaleString()}</td>
            <td>${new Date(s.endTs).toLocaleString()}</td>
            <td>${formatSec(s.durationSec)}</td>
        `;
        tbody.appendChild(tr);
    });
}

/* ================================
   6. Gr치ficos
================================ */
let chartAct = null;
let chartDias = null;

function renderChartActividades(ss){
    const acc = {};
    ss.forEach(s=>{
        if(!acc[s.name]) acc[s.name]=0;
        acc[s.name]+=s.durationSec;
    });
    const labels = Object.keys(acc);
    const values = Object.values(acc);

    if(chartAct) chartAct.destroy();
    chartAct = new Chart(document.getElementById("chartActividades"),{
        type:"bar",
        data:{ labels, datasets:[{ label:"Segundos", data:values }] }
    });
}

function renderChartDias(ss){
    const acc = {};
    ss.forEach(s=>{
        if(!acc[s.dia]) acc[s.dia]=0;
        acc[s.dia]+=s.durationSec;
    });
    const labels = Object.keys(acc).map(d=>"D칤a "+d);
    const values = Object.values(acc);

    if(chartDias) chartDias.destroy();
    chartDias = new Chart(document.getElementById("chartDias"),{
        type:"line",
        data:{ labels, datasets:[{ label:"Segundos", data:values, tension:0.3 }] }
    });
}

/* ================================
   7. Render TOTAL
================================ */
function renderTodo(){
    const ss = filtrarSesiones();
    renderResumen(ss);
    renderTabla(ss);
    renderChartActividades(ss);
    renderChartDias(ss);
}

renderTodo();
</script>

</body>
</html>




