<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Estad√≠sticas</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body{font-family:Segoe UI,system-ui;padding:18px;background:#f5f6f8;color:#111}
  .card{background:#fff;border-radius:10px;padding:14px;margin-bottom:14px;
        box-shadow:0 2px 8px rgba(0,0,0,0.06)}
  h1{margin:0 0 8px}
  #filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,input{padding:6px;border-radius:6px;border:1px solid #ddd}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .small{font-size:12px;color:#666}
</style>
</head>

<body>
<h1>üìä Estad√≠sticas</h1>

<div class="card small">
  Esta p√°gina usa los datos guardados por tu Index en
  <b>localStorage.registroProcesado</b>.
</div>

<div class="card">
  <div id="filters">
    <select id="filterDia"><option value="">Todos los d√≠as</option></select>
    <select id="filterFecha"><option value="">Todas las fechas</option></select>
    <input id="filterName" placeholder="Buscar actividad" />
    <button id="refreshBtn">üîÅ Actualizar</button>
    <div style="margin-left:auto" id="status" class="small"></div>
  </div>
</div>

<div class="card">
  <h3>Resumen</h3>
  <div id="resumen" class="small"></div>
</div>

<div class="card">
  <h3>Tiempo por actividad</h3>
  <canvas id="chartActividades" height="120"></canvas>
</div>

<div class="card">
  <h3>Tiempo por d√≠a</h3>
  <canvas id="chartDias" height="120"></canvas>
</div>

<div class="card">
  <h3>Sesiones</h3>
  <table>
    <thead>
      <tr>
        <th>Actividad</th>
        <th>D√≠a</th>
        <th>Fecha</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Duraci√≥n</th>
        <th>Objetivo (min)</th>
        <th>Cumplido</th>
      </tr>
    </thead>
    <tbody id="tablaSesiones"></tbody>
  </table>
</div>

<script>

/* Utilidades */
function toPeruString(ts) {
  if (!ts) return "";
  return new Date(ts).toLocaleString("sv-SE", {
    timeZone: "America/Lima",
    hour12: false
  }).replace("T", " ");
}

function formatSec(s){
  s = Number(s||0);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const se = s%60;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(se).padStart(2,"0")}`;
}

function marcaToSec(str){
  if (!str) return 0;
  const p = str.split(":").map(Number);
  return p[0]*3600 + p[1]*60 + p[2];
}

function $(id){ return document.getElementById(id); }

function escapeHtml(u){
  if (!u) return "";
  return String(u).replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
}

/* === CARGAR FILAS DEL REGISTRO === */
let registro = [];

function loadRegistro(){
  const raw = localStorage.getItem("registroFilas");
  if (!raw) return [];
  try {
    return JSON.parse(raw);
  } catch(e){
    console.error("Error parsing registroFilas:", e);
    return [];
  }
}

/* === FILTRO === */
function filtrar(){
  const d  = $('filterDia').value;
  const f  = $('filterFecha').value;
  const q  = $('filterName').value.trim().toLowerCase();

  return registro.filter(r => {
    if (d && String(r.dia) !== String(d)) return false;
    const fecha = r.timestamp.slice(0,10);
    if (f && fecha !== f) return false;
    if (q && !String(r.nombre||"").toLowerCase().includes(q)) return false;
    return true;
  });
}

/* === TABLA === */
function renderTabla(){
  const lista = filtrar();
  const tb = $('tablaSesiones');
  tb.innerHTML = "";

  lista.forEach(r => {
    const durSec = marcaToSec(r.marca);
    const objetivoMin = Number(r.objetivo) || 0;
    const objetivoSec = objetivoMin * 60;
    const cumplido = objetivoMin > 0 ? (durSec >= objetivoSec ? "‚úî" : "‚úñ") : "‚Äî";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.nombre || "")}</td>
      <td>${r.dia || ""}</td>
      <td>${r.timestamp.slice(0,10)}</td>
      <td>${toPeruString(r.timestamp)}</td>
      <td>${formatSec(durSec)}</td>
      <td>${objetivoMin}</td>
      <td>${cumplido}</td>
    `;
    tb.appendChild(tr);
  });
}

/* === RESUMEN === */
function renderResumen(){
  const lista = filtrar();

  const totalSec = lista.reduce(
    (a,r)=> a + marcaToSec(r.marca), 0
  );

  const dias = [...new Set(lista.map(r=>r.dia).filter(Boolean))];
  const fechas = [...new Set(lista.map(r=> r.timestamp.slice(0,10) ))];

  $('resumen').innerHTML = `
    <p><b>Tiempo total:</b> ${formatSec(totalSec)}</p>
    <p><b>D√≠as trabajados:</b> ${dias.length}</p>
    <p><b>Fechas √∫nicas:</b> ${fechas.length}</p>
  `;
}

/* === GR√ÅFICAS === */
let chartAct=null, chartDia=null;

function renderGraficas(){
  const lista = filtrar();

  const act = {};
  const porDia = {};

  lista.forEach(r => {
    const n = r.nombre || "‚Äî";
    const d = r.dia || "‚Äî";
    const sec = marcaToSec(r.marca);

    act[n] = (act[n] || 0) + sec;
    porDia[d] = (porDia[d] || 0) + sec;
  });

  if (chartAct) chartAct.destroy();
  chartAct = new Chart($("chartActividades"), {
    type:"bar",
    data:{
      labels:Object.keys(act),
      datasets:[{label:"Segundos", data:Object.values(act)}]
    }
  });

  if (chartDia) chartDia.destroy();
  chartDia = new Chart($("chartDias"), {
    type:"line",
    data:{
      labels:Object.keys(porDia).map(d=> d==="‚Äî" ? "Sin d√≠a" : `D√≠a ${d}`),
      datasets:[{label:"Segundos", data:Object.values(porDia), tension:0.25}]
    }
  });
}

/* === FILTROS === */
function initFilters(){
  // D√≠a
  const fd = $('filterDia');
  fd.innerHTML = `<option value="">Todos los d√≠as</option>`;
  const dias = [...new Set(registro.map(r=>r.dia).filter(Boolean))].sort((a,b)=>a-b);
  dias.forEach(d => fd.innerHTML += `<option value="${d}">D√≠a ${d}</option>`);

  // Fecha
  const ff = $('filterFecha');
  ff.innerHTML = `<option value="">Todas las fechas</option>`;
  const fechas = [...new Set(registro.map(r=>r.timestamp.slice(0,10)))].sort();
  fechas.forEach(f => ff.innerHTML += `<option value="${f}">${f}</option>`);
}

/* === REFRESCAR === */
function refrescar(){
  renderTabla();
  renderResumen();
  renderGraficas();
  $('status').textContent = "Listo";
}

/* === START === */
registro = loadRegistro();

if (!registro || registro.length === 0) {
  $('status').textContent = "No hay registroFilas en localStorage";
} else {
  $('status').textContent = "Cargando...";
  initFilters();
  refrescar();
}

/* Eventos */
$('refreshBtn').onclick = refrescar;
$('filterDia').onchange = refrescar;
$('filterFecha').onchange = refrescar;
$('filterName').oninput = () => setTimeout(refrescar,250);

</script>



</body>
</html>


















