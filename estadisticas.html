<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Estad√≠sticas</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body{font-family:Segoe UI,system-ui;padding:18px;background:#f5f6f8;color:#111}
  .card{background:#fff;border-radius:10px;padding:14px;margin-bottom:14px;
        box-shadow:0 2px 8px rgba(0,0,0,0.06)}
  h1{margin:0 0 8px}
  #filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,input{padding:6px;border-radius:6px;border:1px solid #ddd}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .small{font-size:12px;color:#666}
</style>
</head>

<body>
<h1>üìä Estad√≠sticas</h1>

<div class="card small">
  Esta p√°gina usa los datos guardados por tu Index en
  <b>localStorage.registroProcesado</b>.
</div>

<div class="card">
  <div id="filters">
    <select id="filterDia"><option value="">Todos los d√≠as</option></select>
    <select id="filterFecha"><option value="">Todas las fechas</option></select>
    <input id="filterName" placeholder="Buscar actividad" />
    <button id="refreshBtn">üîÅ Actualizar</button>
    <div style="margin-left:auto" id="status" class="small"></div>
  </div>
</div>

<div class="card">
  <h3>Resumen</h3>
  <div id="resumen" class="small"></div>
</div>

<div class="card">
  <h3>Tiempo por actividad</h3>
  <canvas id="chartActividades" height="120"></canvas>
</div>

<div class="card">
  <h3>Tiempo por d√≠a</h3>
  <canvas id="chartDias" height="120"></canvas>
</div>

<div class="card">
  <h3>Sesiones</h3>
  <table>
    <thead>
      <tr>
        <th>Actividad</th>
        <th>D√≠a</th>
        <th>Fecha</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Duraci√≥n</th>
        <th>Objetivo (min)</th>
        <th>Cumplido</th>
      </tr>
    </thead>
    <tbody id="tablaSesiones"></tbody>
  </table>
</div>

<script>

/* ------------------------------
   Formato B: YYYY-MM-DD HH:mm:ss
   Hora Per√∫
--------------------------------*/
function toPeruString(ts) {
  if (!ts) return "";
  let d;
  // Puede ser n√∫mero o ISO string
  if (typeof ts === "number") d = new Date(ts);
  else d = new Date(ts);

  if (isNaN(d.getTime())) return "";

  return d.toLocaleString("sv-SE", {
    timeZone: "America/Lima",
    hour12: false
  }).replace("T"," ");
}

/* Convertir segundos a texto */
function formatSec(s){
  s = Number(s||0);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const se = s%60;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(se).padStart(2,"0")}`;
}

function $(id){ return document.getElementById(id); }

/* Cargar datos */
let registro = null;

function loadRegistro(){
  const raw = localStorage.getItem("registroProcesado");
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch(e){
    console.error("Error parsing registroProcesado:", e);
    return null;
  }
}

function escapeHtml(u){
  if (!u) return "";
  return String(u).replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
}

/* Obtener meta */
function getMeta(tid, name){
  const tm = registro.timersMeta || {};
  if (tid && tm[tid]) {
    const t = Number(tm[tid].target || tm[tid].targetMin || tm[tid].targetMinutes || 0) || 0;
    return { targetMin: t, name: tm[tid].name || name || tid };
  }
  // fallback por nombre
  for (const k of Object.keys(tm)){
    if (tm[k].name === name) {
      const t = Number(tm[k].target || tm[k].targetMin || tm[k].targetMinutes || 0) || 0;
      return { targetMin: t, name: tm[k].name };
    }
  }
  return { targetMin: 0, name: name || tid };
}

/* Filtros */
function filtrar(){
  if (!registro) return [];
  const d  = $('filterDia').value;
  const f  = $('filterFecha').value;
  const q  = $('filterName').value.trim().toLowerCase();

  return registro.sessions
    .filter(s => {
      if (d && String(s.dia) !== String(d)) return false;
      if (f && s.dateKey !== f) return false;
      if (q && !(s.name||"").toLowerCase().includes(q)) return false;
      return true;
    })
    .sort((a,b)=> new Date(a.startTs) - new Date(b.startTs));
}

/* Tabla */
function renderTabla(){
  const lista = filtrar();
  const tb = $('tablaSesiones');
  tb.innerHTML = "";

  const acumulado = {};

  lista.forEach(s => {
    const tid = s.timerId || "_";
    acumulado[tid] = (acumulado[tid] || 0) + Number(s.durationSec||0);

    const meta = getMeta(s.timerId, s.name);
    const objetivoMin = meta.targetMin || 0;
    const objetivoSec = objetivoMin * 60;

    const cumplido = objetivoSec > 0
      ? (acumulado[tid] >= objetivoSec ? "‚úî" : "‚úñ")
      : "‚Äî";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(meta.name)}</td>
      <td>${s.dia||""}</td>
      <td>${s.dateKey||""}</td>
      <td>${toPeruString(s.startTs)}</td>
      <td>${toPeruString(s.endTs)}</td>
      <td>${formatSec(s.durationSec)}</td>
      <td>${objetivoMin}</td>
      <td>${cumplido}</td>
    `;
    tb.appendChild(tr);
  });
}

/* Rachas y resumen */
function renderResumen(){
  const lista = filtrar();
  const total = lista.reduce((a,b)=> a + Number(b.durationSec||0), 0);

  const dias = [...new Set(lista.map(s=>s.dia).filter(x=>x!=null))];
  const fechas = [...new Set(lista.map(s=>s.dateKey).filter(x=>x))];

  const trabajadoPorDia = {};
  const timersPorDia = {};

  lista.forEach(s=>{
    if (s.dia==null) return;
    trabajadoPorDia[s.dia] = (trabajadoPorDia[s.dia]||0) + Number(s.durationSec||0);
    timersPorDia[s.dia] = timersPorDia[s.dia] || new Set();
    if (s.timerId) timersPorDia[s.dia].add(s.timerId);
  });

  const objetivosPorDia = {};
  Object.keys(timersPorDia).forEach(d=>{
    let sum = 0;
    timersPorDia[d].forEach(tid=>{
      const meta = getMeta(tid);
      sum += (meta.targetMin||0)*60;
    });
    objetivosPorDia[d] = sum;
  });

  // racha
  let racha=0, maxRacha=0, prev=null;
  const diasOrd = Object.keys(trabajadoPorDia).map(Number).sort((a,b)=>a-b);

  diasOrd.forEach(d=>{
    const cumpl = objetivosPorDia[d] > 0 && trabajadoPorDia[d] >= objetivosPorDia[d];
    if (prev===null || d===prev+1) racha = cumpl ? racha+1 : 0;
    else racha = cumpl ? 1 : 0;
    maxRacha = Math.max(maxRacha, racha);
    prev = d;
  });

  $('resumen').innerHTML = `
    <p><b>Tiempo total:</b> ${formatSec(total)}</p>
    <p><b>D√≠as trabajados:</b> ${dias.length}</p>
    <p><b>Fechas √∫nicas:</b> ${fechas.length}</p>
    <p><b>Racha m√°xima:</b> ${maxRacha}</p>
  `;
}

/* Gr√°ficas */
let chartAct=null, chartDia=null;

function renderGraficas(){
  const lista = filtrar();

  const act = {}, dia={};

  lista.forEach(s=>{
    const n = s.name || getMeta(s.timerId).name || s.timerId || "‚Äî";
    act[n] = (act[n]||0) + Number(s.durationSec||0);
    const dk = s.dia || "‚Äî";
    dia[dk] = (dia[dk]||0) + Number(s.durationSec||0);
  });

  if(chartAct) chartAct.destroy();
  chartAct = new Chart($("chartActividades"), {
    type:"bar",
    data:{
      labels:Object.keys(act),
      datasets:[{label:"Segundos",data:Object.values(act)}]
    }
  });

  if(chartDia) chartDia.destroy();
  chartDia = new Chart($("chartDias"), {
    type:"line",
    data:{
      labels:Object.keys(dia).map(d=> d==="‚Äî" ? "Sin d√≠a" : `D√≠a ${d}`),
      datasets:[{label:"Segundos",data:Object.values(dia),tension:0.25}]
    }
  });
}

/* Inicializar filtros */
function initFilters(){
  const fd = $('filterDia');
  fd.innerHTML = `<option value="">Todos los d√≠as</option>`;
  (registro.dias||[])
    .sort((a,b)=>a.dia-b.dia)
    .forEach(d=>{
      fd.innerHTML += `<option value="${d.dia}">D√≠a ${d.dia}</option>`;
    });

  const fechas = [...new Set((registro.sessions||[]).map(s=>s.dateKey).filter(x=>x))].sort();
  const ff = $('filterFecha');
  ff.innerHTML = `<option value="">Todas las fechas</option>`;
  fechas.forEach(f => ff.innerHTML += `<option value="${f}">${f}</option>`);
}

/* Refrescar todo */
function refrescar(){
  if (!registro){
    $('status').textContent = "Sin datos";
    return;
  }
  renderTabla();
  renderResumen();
  renderGraficas();
  $('status').textContent = "Listo";
}

/* START */
registro = loadRegistro();

if (!registro) {
  $('status').textContent = "No hay registroProcesado en localStorage";
} else {
  $('status').textContent = "Cargando...";
  initFilters();
  refrescar();
}

/* eventos */
$('refreshBtn').onclick = refrescar;
$('filterDia').onchange = refrescar;
$('filterFecha').onchange = refrescar;
$('filterName').oninput = () => setTimeout(refrescar,250);

</script>

</body>
</html>















